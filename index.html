<script>
const SHEET_ID = "1-G3-rNuXbfeqqutJ-WQoWN7c4GeqVsNVwXj97xubTzk";
const API_KEY = "AIzaSyDDkXyNbhR3owXHaCAwFOSAO6a_juCZoN8";
const SHEET_NAMES = ["Wire","Box's/covers","Connectors/Straps","Recepticals/Switches/Plugs","Conduit","Breakers"];

let sheetDataCache = {};
let orders = [];

function normalize(str){ return str.replace(/\s+/g,'').toLowerCase(); }

async function loadSheet(sheetName){
  if(sheetDataCache[sheetName]) return sheetDataCache[sheetName];
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  const rows = (data.values||[]).map(r => ({item:r[0], price: parseFloat(r[1])}));
  sheetDataCache[sheetName] = rows;
  return rows;
}

async function loadAllSheets(){
  for(const name of SHEET_NAMES) await loadSheet(name);
}
loadAllSheets();

async function getLivePrice(itemName){
  // Replace this URL with your own backend endpoint later
  const apiUrl = `https://your-server.com/getPrice?item=${encodeURIComponent(itemName)}`;
  try {
    const res = await fetch(apiUrl);
    if(!res.ok) throw new Error("Server error");
    const data = await res.json();
    return data.price;
  } catch(e){
    console.error("Live price fetch failed:", e);
    return null;
  }
}

async function addItem(){
  const item = document.getElementById("itemInput").value.trim();
  const qty = parseFloat(document.getElementById("qtyInput").value);
  const errorDiv = document.getElementById("error");
  errorDiv.textContent = "";

  if(!item || qty<=0){ errorDiv.textContent="Enter valid item and quantity >0"; return; }

  await loadAllSheets();
  let found = null;
  for(const sheet of SHEET_NAMES){
    const rows = sheetDataCache[sheet];
    found = rows.find(r => normalize(r.item)===normalize(item));
    if(found) break;
  }

  // Try getting live price if not found in Sheets
  let price = found ? found.price : null;
  if(!price){
    const live = await getLivePrice(item);
    if(live) price = live;
  }

  if(!price){ errorDiv.textContent="Error: item not found"; return; }

  const subtotal = price*qty;
  orders.push({item, qty, price, subtotal});
  renderOrders();
  document.getElementById("itemInput").value="";
  document.getElementById("qtyInput").value=1;
}

function renderOrders(){
  const tbody = document.getElementById("ordersBody");
  tbody.innerHTML="";
  let total=0;
  orders.forEach(o=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${o.item}</td><td>${o.qty}</td><td>${o.price}</td><td>${o.subtotal}</td>`;
    tbody.appendChild(tr);
    total+=o.subtotal;
  });
  document.getElementById("result").textContent=`Total: $${total.toFixed(2)}`;
}

function clearOrders(){ orders=[]; renderOrders(); document.getElementById("error").textContent=""; }
</script>

