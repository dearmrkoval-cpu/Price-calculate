<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Material Price Calculator</title>
<style>
body{font-family:system-ui,sans-serif;padding:20px;background:#f9f9f9;}
input,button,select{width:100%;padding:10px;margin:8px 0;font-size:16px;}
#orders table{width:100%;border-collapse:collapse;}
#orders th,#orders td{border:1px solid #ccc;padding:8px;text-align:center;}
#orders td input{padding:6px 8px;font-size:14px;width:100px;}
#result{margin-top:15px;font-weight:bold;font-size:20px;color:#007700;}
#error{color:red;font-weight:bold;margin-top:5px;}
#generatedOutput{background:#eee;padding:10px;white-space:pre-wrap;}
#copyBtn{margin-top:10px;display:none;} /* hidden until generate */
.editBtn{font-size:14px;padding:6px 10px;background:#0077cc;color:white;
  border-radius:6px;text-decoration:none;margin-left:10px;display:flex;align-items:center;gap:5px;}
</style>
</head>
<body>

<h2 style="display:flex;justify-content:space-between;align-items:center;">
  Material Price Calculator
  <a href="https://docs.google.com/spreadsheets/d/1-G3-rNuXbfeqqutJ-WQoWN7c4GeqVsNVwXj97xubTzk/edit?usp=sharing" 
     target="_blank" class="editBtn">‚úè Edit</a>
</h2>

<!-- Unit switch applies only for Wire and Conduit -->
<label>Units (only for Wire & Conduit):</label>
<select id="unitSelect">
  <option value="meter">Meters</option>
  <option value="foot">Feet</option>
</select>

<label>Item name:</label>
<input id="itemInput" list="suggestions" placeholder="e.g. BX2/12">
<datalist id="suggestions"></datalist>

<label>Quantity:</label>
<input id="qtyInput" type="number" value="1" min="1">

<button onclick="addItem()">Add Item</button>
<button onclick="clearOrders()">Clear Orders</button>
<button onclick="generateList()">Generate</button>

<div id="error"></div>

<div id="orders">
  <table>
    <thead>
      <tr><th>Item</th><th>Quantity</th><th>Price</th><th>Subtotal</th></tr>
    </thead>
    <tbody id="ordersBody"></tbody>
  </table>
</div>

<div id="result"></div>

<h3>Generated List:</h3>
<pre id="generatedOutput"></pre>
<button id="copyBtn" onclick="copyText()">Copy</button>

<script>
// Google Sheets configuration
const SHEET_ID = "1-G3-rNuXbfeqqutJ-WQoWN7c4GeqVsNVwXj97xubTzk"; 
const API_KEY = "AIzaSyDDkXyNbhR3owXHaCAwFOSAO6a_juCZoN8"; 
const SHEET_NAMES = [
  "Wire",
  "Box's/covers",
  "Connectors/Straps",
  "Recepticals/Switches/Plugs",
  "Conduit",
  "Breakers",
  "Fuses"
];

let sheetDataCache = {};
let orders = []; // { item, qty (number), price (number), subtotal (number), category }

// Conversion constant
const METER_TO_FOOT = 3.28084;

// Normalize string: remove spaces, lowercase, reorder BX/Romex patterns
function normalize(str){
  return str
    .replace(/\s+/g,'')             // remove spaces
    .replace(/(.*)(bx)$/i,'bx$1')   // put BX in front if at the end
    .replace(/(.*)(romex)$/i,'romex$1') // put Romex in front if at the end
    .toLowerCase();
}

// Load data from one sheet
async function loadSheet(sheetName){
  if(sheetDataCache[sheetName]) return sheetDataCache[sheetName];
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();

  // Take item name from column 1, price from column 3 (allow "3,67" or "3.67")
  const rows = (data.values||[]).map(r => ({
    item: r[0],
    price: r[2] ? parseFloat(r[2].toString().replace(',', '.')) : 0
  }));

  sheetDataCache[sheetName] = rows;
  return rows;
}

// Preload all sheets
async function loadAllSheets(){
  for(const name of SHEET_NAMES) await loadSheet(name);
}
loadAllSheets();

// Add item to order
async function addItem(){
  const item = document.getElementById("itemInput").value.trim();
  const qty = parseFloat(document.getElementById("qtyInput").value);
  const unit = document.getElementById("unitSelect").value;
  const errorDiv = document.getElementById("error");
  errorDiv.textContent = "";

  if(!item || qty<=0){ 
    errorDiv.textContent="Enter valid item and quantity >0"; 
    return; 
  }

  await loadAllSheets();

  let found = null, sheetNameFound = null;
  for(const sheet of SHEET_NAMES){
    const rows = sheetDataCache[sheet];
    found = rows.find(r => normalize(r.item)===normalize(item));
    if(found){ sheetNameFound = sheet; break; }
  }

  if(!found){ 
    errorDiv.textContent="Error: incorrect name"; 
    return; 
  }

  let price = found.price;
  // Apply unit conversion if Wire or Conduit (sheet prices are per meter)
  if(sheetNameFound==="Wire" || sheetNameFound==="Conduit"){
    if(unit==="foot") price = price / METER_TO_FOOT;
  }

  const subtotal = +(price * qty).toFixed(2);
  orders.push({item, qty, price: +price.toFixed(2), subtotal, category: sheetNameFound});
  renderOrders();

  document.getElementById("itemInput").value="";
  document.getElementById("qtyInput").value=1;
}

// Render orders in table (no innerHTML mutations after attaching listeners)
function renderOrders(){
  const tbody = document.getElementById("ordersBody");
  tbody.innerHTML="";
  let total=0;

  orders.forEach((o, index)=>{
    total += o.subtotal;

    const tr = document.createElement("tr");

    const tdItem = document.createElement("td");
    tdItem.textContent = o.item;

    const tdQty = document.createElement("td");
    tdQty.textContent = o.qty;

    const tdPrice = document.createElement("td");
    tdPrice.textContent = `$${o.price.toFixed(2)}`;
    tdPrice.style.cursor = "pointer";
    tdPrice.title = "Click to edit price for this row";
    tdPrice.addEventListener("click", () => makePriceEditable(tdPrice, index));

    const tdSubtotal = document.createElement("td");
    tdSubtotal.textContent = `$${o.subtotal.toFixed(2)}`;

    tr.append(tdItem, tdQty, tdPrice, tdSubtotal);
    tbody.appendChild(tr);
  });

  document.getElementById("result").textContent=`Total: $${total.toFixed(2)}`;
}

// Turn price cell into an input, commit on blur/Enter, cancel on Esc
function makePriceEditable(cell, idx){
  const current = Number(orders[idx].price);
  const input = document.createElement("input");
  input.type = "number";
  input.step = "0.01";
  input.min = "0";
  input.value = current.toFixed(2);
  input.style.width = "100px";

  cell.textContent = "";
  cell.appendChild(input);
  input.focus();
  input.select();

  const commit = () => {
    const val = parseFloat(input.value);
    if(!isNaN(val) && val > 0){
      orders[idx].price = +val.toFixed(2);
      orders[idx].subtotal = +(orders[idx].price * orders[idx].qty).toFixed(2);
    }
    renderOrders();
  };

  input.addEventListener("blur", commit);
  input.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ e.preventDefault(); input.blur(); }
    if(e.key === "Escape"){ e.preventDefault(); renderOrders(); }
  });
}

// Clear all orders
function clearOrders(){ 
  orders=[]; 
  renderOrders(); 
  document.getElementById("error").textContent=""; 
  document.getElementById("generatedOutput").textContent=""; 
  document.getElementById("copyBtn").style.display="none";
}

// Generate formatted list + total line
function generateList(){
  let output = "";
  const unit = document.getElementById("unitSelect").value;
  let total=0;
  orders.forEach(o=>{
    let unitSuffix = "";
    if(o.category==="Wire" || o.category==="Conduit"){
      unitSuffix = (unit==="meter" ? "m" : "ft");
    }
    total += o.subtotal;
    output += `${o.qty}${unitSuffix} - ${o.item}\n`;
  });
  if(orders.length>0){
    output += `\nCost of above material ${total.toFixed(2)}$`;
  }
  document.getElementById("generatedOutput").textContent = output || "No items";
  document.getElementById("copyBtn").style.display = (orders.length>0 ? "inline-block" : "none");
}

// Copy to clipboard
function copyText(){
  const text = document.getElementById("generatedOutput").textContent;
  navigator.clipboard.writeText(text).then(()=>{
    alert("Copied to clipboard!");
  });
}

// Update autocomplete suggestions
function updateSuggestions(){
  const input = document.getElementById("itemInput").value.toLowerCase();
  const datalist = document.getElementById("suggestions");
  datalist.innerHTML = "";
  if(input.length<2) return;

  const matches = [];
  for(const sheet of SHEET_NAMES){
    const rows = sheetDataCache[sheet] || [];
    rows.forEach(r=>{
      if(r.item && r.item.toLowerCase().includes(input)){
        if(!matches.includes(r.item)) matches.push(r.item);
      }
    });
  }

  matches.forEach(m=>{
    const option=document.createElement("option");
    option.value=m;
    datalist.appendChild(option);
  });
}
document.getElementById("itemInput").addEventListener("input", updateSuggestions);
</script>

</body>
</html>
