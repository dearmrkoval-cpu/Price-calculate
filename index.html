<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Material Price Calculator</title>
<style>
body{font-family:system-ui,sans-serif;padding:20px;background:#f9f9f9;}
input,button,select{width:100%;padding:10px;margin:8px 0;font-size:16px;}
#orders table{width:100%;border-collapse:collapse;}
#orders th,#orders td{border:1px solid #ccc;padding:8px;text-align:center;}
#result{margin-top:15px;font-weight:bold;font-size:20px;color:#007700;}
#error{color:red;font-weight:bold;margin-top:5px;}
#generatedOutput{background:#eee;padding:10px;white-space:pre-wrap;}
#copyBtn{margin-top:10px;display:none;} /* скрыт по умолчанию */
</style>
</head>
<body>

<h2>Material Price Calculator</h2>

<!-- Unit switch applies only for Wire and Conduit -->
<label>Units (only for Wire & Conduit):</label>
<select id="unitSelect">
  <option value="meter">Meters</option>
  <option value="foot">Feet</option>
</select>

<label>Item name:</label>
<input id="itemInput" list="suggestions" placeholder="e.g. BX2/12">
<datalist id="suggestions"></datalist>

<label>Quantity:</label>
<input id="qtyInput" type="number" value="1" min="1">

<button onclick="addItem()">Add Item</button>
<button onclick="clearOrders()">Clear Orders</button>
<button onclick="generateList()">Generate</button>

<div id="error"></div>

<div id="orders">
  <table>
    <thead>
      <tr><th>Item</th><th>Quantity</th><th>Price</th><th>Subtotal</th></tr>
    </thead>
    <tbody id="ordersBody"></tbody>
  </table>
</div>

<div id="result"></div>

<h3>Generated List:</h3>
<pre id="generatedOutput"></pre>
<button id="copyBtn" onclick="copyText()">Copy</button>

<script>
// Google Sheets configuration
const SHEET_ID = "1-G3-rNuXbfeqqutJ-WQoWN7c4GeqVsNVwXj97xubTzk"; 
const API_KEY = "AIzaSyDDkXyNbhR3owXHaCAwFOSAO6a_juCZoN8"; 
const SHEET_NAMES = [
  "Wire",
  "Box's/covers",
  "Connectors/Straps",
  "Recepticals/Switches/Plugs",
  "Conduit",
  "Breakers",
  "Fuses"
];

let sheetDataCache = {};
let orders = [];

// Conversion constant
const METER_TO_FOOT = 3.28084;

// Normalize string
function normalize(str){
  return str
    .replace(/\s+/g,'')
    .replace(/(.*)(bx)/i,'bx$1')
    .replace(/(.*)(romex)/i,'romex$1')
    .toLowerCase();
}

// Load data
async function loadSheet(sheetName){
  if(sheetDataCache[sheetName]) return sheetDataCache[sheetName];
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  const rows = (data.values||[]).map(r => ({
    item: r[0],
    price: r[2] ? parseFloat(r[2].toString().replace(',', '.')) : 0
  }));
  sheetDataCache[sheetName] = rows;
  return rows;
}

async function loadAllSheets(){
  for(const name of SHEET_NAMES) await loadSheet(name);
}
loadAllSheets();

// Add item
async function addItem(){
  const item = document.getElementById("itemInput").value.trim();
  const qty = parseFloat(document.getElementById("qtyInput").value);
  const unit = document.getElementById("unitSelect").value;
  const errorDiv = document.getElementById("error");
  errorDiv.textContent = "";

  if(!item || qty<=0){ 
    errorDiv.textContent="Enter valid item and quantity >0"; 
    return; 
  }

  await loadAllSheets();

  let found = null, sheetNameFound = null;
  for(const sheet of SHEET_NAMES){
    const rows = sheetDataCache[sheet];
    found = rows.find(r => normalize(r.item)===normalize(item));
    if(found){ sheetNameFound = sheet; break; }
  }

  if(!found){ 
    errorDiv.textContent="Error: incorrect name"; 
    return; 
  }

  let price = found.price;
  if(sheetNameFound==="Wire" || sheetNameFound==="Conduit"){
    if(unit==="foot") price = price / METER_TO_FOOT;
  }

  const subtotal = (price * qty).toFixed(2);
  orders.push({item, qty, price: price.toFixed(2), subtotal, category: sheetNameFound});
  renderOrders();

  document.getElementById("itemInput").value="";
  document.getElementById("qtyInput").value=1;
}

// Render
function renderOrders(){
  const tbody = document.getElementById("ordersBody");
  tbody.innerHTML="";
  let total=0;
  orders.forEach(o=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${o.item}</td><td>${o.qty}</td><td>$${o.price}</td><td>$${o.subtotal}</td>`;
    tbody.appendChild(tr);
    total += parseFloat(o.subtotal);
  });
  document.getElementById("result").textContent=`Total: $${total.toFixed(2)}`;
}

// Clear
function clearOrders(){ 
  orders=[]; 
  renderOrders(); 
  document.getElementById("error").textContent=""; 
  document.getElementById("generatedOutput").textContent=""; 
  document.getElementById("copyBtn").style.display="none";
}

// Generate formatted list
function generateList(){
  let output = "";
  const unit = document.getElementById("unitSelect").value;
  let total=0;
  orders.forEach(o=>{
    let unitSuffix = "";
    if(o.category==="Wire" || o.category==="Conduit"){
      unitSuffix = (unit==="meter" ? "m" : "ft");
    }
    total += parseFloat(o.subtotal);
    output += `${o.qty}${unitSuffix} - ${o.item}\n`;
  });
  if(orders.length>0){
    output += `\nCoast of above material ${total.toFixed(2)}$`;
  }
  document.getElementById("generatedOutput").textContent = output || "No items";
  document.getElementById("copyBtn").style.display = (orders.length>0 ? "inline-block" : "none");
}

// Copy to clipboard
function copyText(){
  const text = document.getElementById("generatedOutput").textContent;
  navigator.clipboard.writeText(text).then(()=>{
    alert("Copied to clipboard!");
  });
}

// Autocomplete
function updateSuggestions(){
  const input = document.getElementById("itemInput").value.toLowerCase();
  const datalist = document.getElementById("suggestions");
  datalist.innerHTML = "";
  if(input.length<2) return;
  let matches = [];
  for(const sheet of SHEET_NAMES){
    const rows = sheetDataCache[sheet] || [];
    rows.forEach(r=>{
      if(r.item && r.item.toLowerCase().includes(input)){
        if(!matches.includes(r.item)) matches.push(r.item);
      }
    });
  }
  matches.forEach(m=>{
    const option=document.createElement("option");
    option.value=m;
    datalist.appendChild(option);
  });
}
document.getElementById("itemInput").addEventListener("input", updateSuggestions);
</script>

</body>
</html>
