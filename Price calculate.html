<script>
const SHEET_ID = "1-G3-rNuXbfeqqutJ-WQoWN7c4GeqVsNVwXj97xubTzk"; // твой Google Sheet ID
const API_KEY = "AIzaSyDDkXyNbhR3owXHaCAwFOSAO6a_juCZoN8"; // твой API Key
const SHEET_NAMES = ["Wire","Box's/covers","Connectors/Straps","Recepticals/Switches/Plugs","Conduit","Breakers"];

let sheetDataCache = {};
let orders = [];

// нормализация строки (без пробелов, нижний регистр)
function normalize(str){ return str.replace(/\s+/g,'').toLowerCase(); }

// подгрузка данных с листа
async function loadSheet(sheetName){
  if(sheetDataCache[sheetName]) return sheetDataCache[sheetName];
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  // берем цену из колонки 3 (индекс 2)
  const rows = (data.values||[]).map(r => ({item:r[0], price: parseFloat(r[2] || 0)}));
  sheetDataCache[sheetName] = rows;
  return rows;
}

// подгружаем все листы заранее
async function loadAllSheets(){
  for(const name of SHEET_NAMES) await loadSheet(name);
}
loadAllSheets();

async function addItem(){
  const item = document.getElementById("itemInput").value.trim();
  const qty = parseFloat(document.getElementById("qtyInput").value);
  const errorDiv = document.getElementById("error");
  errorDiv.textContent = "";

  if(!item || qty<=0){ errorDiv.textContent="Enter valid item and quantity >0"; return; }

  // ищем товар во всех листах
  await loadAllSheets();
  let found = null;
  for(const sheet of SHEET_NAMES){
    const rows = sheetDataCache[sheet];
    found = rows.find(r => normalize(r.item)===normalize(item));
    if(found) break;
  }

  if(!found){ errorDiv.textContent="Error: incorrect name"; return; }

  const subtotal = found.price*qty;
  orders.push({item, qty, price: found.price, subtotal});
  renderOrders();
  document.getElementById("itemInput").value="";
  document.getElementById("qtyInput").value=1;
}

function renderOrders(){
  const tbody = document.getElementById("ordersBody");
  tbody.innerHTML="";
  let total=0;
  orders.forEach(o=>{
    const tr=document.createElement("tr");
    // показываем цену и subtotal с 2 знаками после запятой
    tr.innerHTML=`<td>${o.item}</td><td>${o.qty}</td><td>${o.price.toFixed(2)}</td><td>${o.subtotal.toFixed(2)}</td>`;
    tbody.appendChild(tr);
    total+=o.subtotal;
  });
  document.getElementById("result").textContent=`Total: $${total.toFixed(2)}`;
}

function clearOrders(){ orders=[]; renderOrders(); document.getElementById("error").textContent=""; }
</script>
